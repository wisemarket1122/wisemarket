<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>WISE market - <%= title %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="header-top">
        <a href="/" class="logo">WISE market</a>
        <div class="header-right">
          <% if (currentUser) { %>
            <span class="welcome"><%= currentUser.nickname %> ë‹˜</span>
            <form action="/auth/logout" method="post" class="logout-form">
              <button type="submit" class="link-button">ë¡œê·¸ì•„ì›ƒ</button>
            </form>
          <% } else { %>
            <a href="/auth/login" class="auth-link">ë¡œê·¸ì¸</a>
            <span class="divider">|</span>
            <a href="/auth/signup" class="auth-link">íšŒì›ê°€ì…</a>
          <% } %>
        </div>
      </div>
      <div class="header-bottom">
        <nav class="nav-main">
          <a href="/market">ìº í¼ìŠ¤ ì¥í„°</a>
          <a href="/community/1">WISIAN ê²Œì‹œíŒ</a>
          <% if (currentUser) { %>
            <a href="/chat">ë‚´ ì±„íŒ…</a>
            <a href="/mypage">ë§ˆì´í˜ì´ì§€</a>
          <% } %>
        </nav>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- ì˜¤ë¥¸ìª½ ìƒë‹¨: ëª©ë¡ìœ¼ë¡œ -->
    <div class="list-top-right">
      <span
        class="d-inline-block"
        tabindex="0"
        data-bs-toggle="popover"
        data-bs-trigger="hover focus"
        data-bs-content="ì±„íŒ…ë°© ëª©ë¡ìœ¼ë¡œ ì´ë™"
      >
        <a href="/chat" class="btn btn-primary btn-action">
          ëª©ë¡ìœ¼ë¡œ
        </a>
      </span>
    </div>

    <h2><%= room.item_title %> ì±„íŒ…</h2>
    <p style="font-size:13px; color:#555;">
      êµ¬ë§¤ì: <%= room.buyer_nickname %> / íŒë§¤ì: <%= room.seller_nickname %>
    </p>

    <hr />

    <div id="chatMessages" style="max-height:400px; overflow-y:auto; margin-bottom:12px;">
      <% if (!messages || messages.length === 0) { %>
        <p>ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      <% } else { %>
        <ul class="list-card">
          <% messages.forEach(function(msg) { %>
            <li>
              <p>
                <strong><%= msg.sender_nickname %></strong>
                <span style="font-size:11px; color:#777;">
                  <%= new Date(msg.created_at).toLocaleString("ko-KR", {
                    month: "2-digit",
                    day: "2-digit",
                    hour: "2-digit",
                    minute: "2-digit"
                  }) %>
                </span>
              </p>
              <p><%= msg.content %></p>
            </li>
          <% }); %>
        </ul>
      <% } %>
    </div>

    <form id="chatForm">
  <div class="form-group">
    <textarea
      id="chatInput"
      name="content"
      rows="3"
      class="form-control"
      placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
      required
    ></textarea>
  </div>
  <span
    class="d-inline-block"
    tabindex="0"
    data-bs-toggle="popover"
    data-bs-trigger="hover focus"
    data-bs-content="ë©”ì‹œì§€ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤"
  >
    <button type="submit" class="btn btn-primary btn-action">
      ë³´ë‚´ê¸°
    </button>
  </span>
</form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
    popoverTriggerList.forEach(el => {
      new bootstrap.Popover(el);
    });
  </script>
  
  <!-- socket.io í´ë¼ì´ì–¸íŠ¸ -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    console.log("âœ… room.ejs socket script loaded");

    const roomId = "<%= room.room_id %>";
    const currentUserId = "<%= currentUser.user_id %>";
    const currentNickname = "<%= currentUser.nickname %>";

    console.log("roomId:", roomId, "currentUserId:", currentUserId, "nickname:", currentNickname);

    const socket = io();

    socket.on("connect", () => {
      console.log("âœ… socket connected:", socket.id);
      socket.emit("joinRoom", {
        roomId,
        userId: currentUserId,
        nickname: currentNickname,
      });
      console.log("ğŸ“¨ joinRoom emitted");
    });

    socket.on("connect_error", (err) => {
      console.error("âŒ socket connect_error:", err);
    });

    const msgBox = document.getElementById("chatMessages");
    const form = document.getElementById("chatForm");
    const input = document.getElementById("chatInput");

    console.log("DOM elements:", { msgBox, form, input });

    // í¼ ì „ì†¡ â†’ ì†Œì¼“ìœ¼ë¡œ ë©”ì‹œì§€ ë³´ë‚´ê¸°
    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const text = input.value.trim();
      console.log("âœï¸ form submit, text =", text);
      if (!text) return;

      socket.emit("chatMessage", { roomId, message: text });
      console.log("ğŸ“¨ chatMessage emitted:", { roomId, message: text });

      input.value = "";
      input.focus();
    });

    // ì„œë²„ì—ì„œ ìƒˆ ë©”ì‹œì§€ ë°›ì•˜ì„ ë•Œ
    socket.on("chatMessage", (data) => {
      console.log("ğŸ“© chatMessage received from server:", data);

      if (String(data.roomId) !== String(roomId)) return;

      const li = document.createElement("li");
      const timeText = new Date(data.created_at).toLocaleTimeString("ko-KR", {
        hour: "2-digit",
        minute: "2-digit",
      });

      li.innerHTML = `
        <p>
          <strong>${data.nickname}</strong>
          <span style="font-size:11px; color:#777;">${timeText}</span>
        </p>
        <p>${data.message}</p>
      `;

      let ul = msgBox.querySelector("ul.list-card");
      if (!ul) {
        ul = document.createElement("ul");
        ul.className = "list-card";
        msgBox.innerHTML = "";
        msgBox.appendChild(ul);
      }

      ul.appendChild(li);
      msgBox.scrollTop = msgBox.scrollHeight;
    });
  </script>

<%- include("../partials/bottom-nav") %>
</body>
</html>

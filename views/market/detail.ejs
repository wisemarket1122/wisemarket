<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>WISE market - <%= title %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <!-- 공통 헤더 -->
  <header>
    <div class="header-inner">
      <div class="header-top">
        <a href="/" class="logo">WISE market</a>
        <div class="header-right">
          <% if (currentUser) { %>
            <span class="welcome"><%= currentUser.nickname %> 님</span>
            <form action="/auth/logout" method="post" class="logout-form">
              <button type="submit" class="link-button">로그아웃</button>
            </form>
          <% } else { %>
            <a href="/auth/login" class="auth-link">로그인</a>
            <span class="divider">|</span>
            <a href="/auth/signup" class="auth-link">회원가입</a>
          <% } %>
        </div>
      </div>
      <div class="header-bottom">
        <nav class="nav-main">


          <% if (currentUser) { %>
            

          <% } %>
        </nav>
      </div>
    </div>
  </header>

  <div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
      <h2 class="mb-0"><%= item.title %></h2>
      <div class="d-flex gap-2">
        <a href="/market" class="btn btn-primary btn-sm">
          목록으로
        </a>
      </div>
    </div>

    <div class="row">
      <!-- 이미지 영역 -->
      <div class="col-md-6 mb-3">
        <% if (images && images.length > 1) { %>
          <!-- 여러 장이면 carousel -->
          <div id="itemImageCarousel" class="carousel slide mb-3" data-bs-ride="carousel">
            <div class="carousel-inner">
              <% images.forEach(function(img, idx) { %>
                <div class="carousel-item <%= idx === 0 ? 'active' : '' %>">
                  <img
                    src="<%= img.image_path %>"
                    class="d-block w-100"
                    alt="상품 이미지"
                  />
                </div>
              <% }); %>
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#itemImageCarousel" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#itemImageCarousel" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Next</span>
            </button>
          </div>
        <% } else if (images && images.length === 1) { %>
          <!-- 한 장이면 단일 이미지 -->
          <img
            src="<%= images[0].image_path %>"
            class="d-block w-100 mb-3"
            alt="상품 이미지"
          />
        <% } else { %>
          <img
            src="https://via.placeholder.com/600x400?text=No+Image"
            class="d-block w-100 mb-3"
            alt="상품 이미지 없음"
          />
        <% } %>
      </div>

      <!-- 정보 영역 -->
      <div class="col-md-6">
        <!-- 상태 뱃지 -->
        <div class="mb-2">
          <% if (item.status === "판매중" || !item.status) { %>
            <span class="badge bg-success">판매중</span>
          <% } else if (item.status === "예약중") { %>
            <span class="badge bg-warning text-dark">예약중</span>
          <% } else if (item.status === "판매완료") { %>
            <span class="badge bg-secondary">판매완료</span>
          <% } %>
        </div>

        <p class="mb-1">
          <strong style="font-size:1.3rem;">
            <%= item.price.toLocaleString("ko-KR") %> 원
          </strong>
        </p>

        <% if (item.category) { %>
          <p class="mb-1 text-muted">
            카테고리: <%= item.category %>
          </p>
        <% } %>

        <p class="mb-1 text-muted">
          판매자: <%= item.seller_nickname %>
        </p>

        <p class="mb-3 text-muted" style="font-size:0.9rem;">
          등록일:
          <%= new Date(item.created_at).toLocaleDateString("ko-KR", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
          }) %>
        </p>

        <hr />

        <h5>상품 설명</h5>
        <p style="white-space:pre-wrap;"><%= item.description %></p>

        <hr />

        <!-- 버튼들 -->
        <div class="d-flex flex-wrap gap-2 mt-2">
          <% if (currentUser && currentUser.user_id === item.seller_id) { %>
            <!-- 판매자 전용: 상태 변경 + 삭제 -->
            <form action="/market/<%= item.item_id %>/status" method="post" class="d-inline">
              <input type="hidden" name="status" value="판매중" />
              <button type="submit" class="btn btn-outline-success btn-sm">
                판매중으로
              </button>
            </form>
            <form action="/market/<%= item.item_id %>/status" method="post" class="d-inline">
              <input type="hidden" name="status" value="예약중" />
              <button type="submit" class="btn btn-outline-warning btn-sm">
                예약중으로
              </button>
            </form>
            <form action="/market/<%= item.item_id %>/status" method="post" class="d-inline">
              <input type="hidden" name="status" value="판매완료" />
              <button type="submit" class="btn btn-outline-secondary btn-sm">
                판매완료로
              </button>
            </form>

            <form action="/market/<%= item.item_id %>/delete" method="post" class="d-inline ms-2">
              <button type="submit" class="btn btn-danger btn-sm"
                onclick="return confirm('정말로 이 상품을 삭제하시겠습니까?');">
                상품 삭제
              </button>
            </form>
          <% } else if (currentUser) { %>
            <!-- 구매자: 채팅하기 버튼 -->
            <form action="/chat/room" method="post" class="d-inline">
              <input type="hidden" name="item_id" value="<%= item.item_id %>" />
              <button type="submit" class="btn btn-primary">
                채팅으로 문의하기
              </button>
            </form>
          <% } else { %>
            <a href="/auth/login" class="btn btn-primary">
              로그인 후 문의하기
            </a>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <%- include("../partials/bottom-nav") %>
</body>
</html>

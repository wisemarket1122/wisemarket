<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>WISE market - <%= title %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="header-top">
        <a href="/" class="logo">WISE market</a>
        <div class="header-right">
          <% if (currentUser) { %>
            <span class="welcome"><%= currentUser.nickname %> 님</span>
            <form action="/auth/logout" method="post" class="logout-form">
              <button type="submit" class="link-button">로그아웃</button>
            </form>
          <% } else { %>
            <a href="/auth/login" class="auth-link">로그인</a>
            <span class="divider">|</span>
            <a href="/auth/signup" class="auth-link">회원가입</a>
          <% } %>
        </div>
      </div>
      <div class="header-bottom">
        <nav class="nav-main">
          <a href="/market">캠퍼스 장터</a>
          <a href="/community/1">WISIAN 게시판</a>
          <% if (currentUser) { %>
            <a href="/chat">내 채팅</a>
            <a href="/mypage">마이페이지</a>
          <% } %>
        </nav>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- 오른쪽 상단: 목록으로 -->
    <div class="list-top-right">
      <span
        class="d-inline-block"
        tabindex="0"
        data-bs-toggle="popover"
        data-bs-trigger="hover focus"
        data-bs-content="채팅방 목록으로 이동"
      >
        <a href="/chat" class="btn btn-primary btn-action">
          목록으로
        </a>
      </span>
    </div>

    <h2><%= room.item_title %> 채팅</h2>
    <p style="font-size:13px; color:#555;">
      구매자: <%= room.buyer_nickname %> / 판매자: <%= room.seller_nickname %>
    </p>

    <hr />

    <div style="max-height:400px; overflow-y:auto; margin-bottom:12px;">
      <% if (!messages || messages.length === 0) { %>
        <p>아직 메시지가 없습니다.</p>
      <% } else { %>
        <ul class="list-card">
          <% messages.forEach(function(msg) { %>
            <li>
              <p>
                <strong><%= msg.sender_nickname %></strong>
                <span style="font-size:11px; color:#777;">
                  <%= new Date(msg.created_at).toLocaleString("ko-KR", {
                    month: "2-digit",
                    day: "2-digit",
                    hour: "2-digit",
                    minute: "2-digit"
                  }) %>
                </span>
              </p>
              <p><%= msg.content %></p>
            </li>
          <% }); %>
        </ul>
      <% } %>
    </div>

    <form action="/chat/<%= room.room_id %>/message" method="post">
      <div class="form-group">
        <textarea
          name="content"
          rows="3"
          class="form-control"
          placeholder="메시지를 입력하세요"
          required
        ></textarea>
      </div>
      <span
        class="d-inline-block"
        tabindex="0"
        data-bs-toggle="popover"
        data-bs-trigger="hover focus"
        data-bs-content="메시지를 전송합니다"
      >
        <button type="submit" class="btn btn-primary btn-action">
          보내기
        </button>
      </span>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
    popoverTriggerList.forEach(el => {
      new bootstrap.Popover(el);
    });
  </script>
</body>
</html>
